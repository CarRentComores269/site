<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Sales - CarRent Comores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .car-card {
            transition: transform 0.3s ease;
        }
        .car-card:hover {
            transform: translateY(-5px);
        }
        .car-image {
            height: 200px;
            object-fit: cover;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        #noResultsMessage {
            display: none;
            text-align: center;
            padding: 20px;
            background-color: #f8d7da;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index_en.html">
                <img src="/assets/logo.jpg" alt="CarRent Comores Logo" width="60" height="60" class="me-3 rounded img-thumbnail">
                CarRent Comores
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index_en.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="rentals_en.html">Rentals</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="sales_en.html">Sales</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="airport-transfer_en.html">Airport Transfer</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about_en.html">About Us</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contact_en.html">Contact Us</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-translate"></i> Language
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="languageDropdown" style="min-width: 80px;">
                            <li><a class="dropdown-item" href="sales.html" onclick="changeLanguage('fr')">FranÃ§ais</a></li>
                            <li><a class="dropdown-item" href="sales_en.html" onclick="changeLanguage('en')">English</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Sales Search Section -->
    <section class="py-5 bg-light">
        <div class="container">
            <div class="row filter-section">
                <h2 class="text-center mb-4">Find Your Ideal Car</h2>
                <div class="col-md-3">
                    <label class="form-label">Category</label>
                    <select id="categoryFilter" class="form-select">
                        <option value="">All Categories</option>
                        <option value="SUV">SUV</option>
                        <option value="Sedan">Sedan</option>
                        <option value="Pickup">Pick up</option>
                        <option value="Bus">Bus</option>
                        <option value="Moto">Moto</option>
                        <option value="Taxi">Taxi</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Price</label>
                    <select id="priceFilter" class="form-select">
                        <option value="">All Prices</option>
                        <option value="500000-2500000">KMF 500,000 - KMF 2,500,000</option>
                        <option value="2500001-5500000">KMF 2,500,000 - KMF 5,500,000</option>
                        <option value="5500001-8000000">KMF 5,500,000 - KMF 8,000,000</option>
                        <option value="8000001-10000000">KMF 8,000,000 - KMF 10,000,000</option>
                        <option value="10000000+">KMF 10,000,000+</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Condition</label>
                    <select id="conditionFilter" class="form-select">
                        <option value="">All Conditions</option>
                        <option value="New">New</option>
                        <option value="Used">Used</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Year</label>
                    <select id="yearFilter" class="form-select">
                        <option value="">All Years</option>
                        <option value="2010">2010</option>
                        <option value="2011">2011</option>
                        <option value="2012">2012</option>
                        <option value="2013">2013</option>
                        <option value="2014">2014</option>
                        <option value="2015">2015</option>
                        <option value="2016">2016</option>
                        <option value="2017">2017</option>
                        <option value="2018">2018</option>
                        <option value="2019">2019</option>
                        <option value="2020">2020</option>
                        <option value="2021">2021</option>
                        <option value="2022">2022</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                    </select>
                </div>
                <div class="col-12 mt-3 text-center">
                    <button id="applyFilters" class="btn btn-primary">Apply Filters</button>
                    <button id="resetFilters" class="btn btn-secondary ms-2">Reset</button>
                </div>
            </div>

            <!-- No Results Message -->
            <div id="noResultsMessage" class="alert alert-warning" role="alert">
                No cars match your current filter criteria. Try adjusting your search.
            </div>

            <!-- Car Listings Section -->
            <div id="carListings" class="row g-4">
            </div>
            <div id="salesVehicleModals"></div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5>CarRent Comores</h5>
                    <p>Comfort, Freedom, Adventure. Rent your ideal car!</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <h5>Contact Us</h5>
                    <p>Email: agence@carrentcomores.site<br>Phone: (+269) 342 45 43 / (+269) 476 45 99</p>
                    
                    <!-- Social Media Icons -->
                    <div class="social-media-icons mt-3">
                        <a href="https://www.facebook.com/share/154wBC54VT/?mibextid=LQQJ4d" target="_blank" class="text-white me-3">
                            <i class="fab fa-facebook-f fa-lg"></i>
                        </a>
                        <a href="https://www.instagram.com/carrentcomore.site?igshid=aDZmaXgyYjhlNzYx&utm_source=qr" target="_blank" class="text-white me-3">
                            <i class="fab fa-instagram fa-lg"></i>
                        </a>
                        <a href="https://wa.me/+2694924019" target="_blank" class="text-white me-3">
                            <i class="fab fa-whatsapp fa-lg"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="row mt-3 border-top pt-3">
                <div class="col-12 text-center">
                    <p class="mb-0">&copy; 2025 CarRent Comores. All Rights Reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global function for WhatsApp contact
        function contactSellerWhatsApp(vehicle) {
            console.log('Contact Seller Clicked', vehicle);
            
            // WhatsApp number
            const whatsappNumber = '+2694924019';
            
            // Detailed message construction
            const message = `ðŸš— Interested in Vehicle Inquiry ðŸš—

Hello CarRent Comores Team,

I saw this ${vehicle.make} on your sales page:

ðŸ“‹ Vehicle Details:
- Make: ${vehicle.make}
- Model: ${vehicle.model}
- Year: ${vehicle.year}
- Plate Number: ${vehicle.plateNumber}
- Price: KMF ${vehicle.price.toLocaleString()}

I would love to get more information about this vehicle. Could you please provide me with additional details?

Thanks,`;
            
            // Encode message
            const encodedMessage = encodeURIComponent(message);
            
            // Construct WhatsApp URL
            const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
            
            console.log('WhatsApp URL:', whatsappUrl);
            
            // Open WhatsApp
            window.location.href = whatsappUrl;
        }

        // Global function to initiate a call
        function callSeller(plateNumber) {
            // Predefined phone number for CarRent
            const phoneNumber = '+2693424543';
            
            console.log('Call Seller Initiated', {
                plateNumber: plateNumber,
                userAgent: navigator.userAgent
            });
            
            // Comprehensive device detection
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            try {
                if (isMobile) {
                    // Mobile device: attempt to initiate a direct call
                    window.location.href = `tel:${phoneNumber}`;
                    console.log('Attempting mobile call');
                } else {
                    // Desktop or unsupported device: show an alert
                    console.log('Desktop device, showing alert');
                    alert(`Call our sales team at ${phoneNumber} for vehicle with plate number: ${plateNumber}`);
                }
            } catch (error) {
                console.error('Error in callSeller:', error);
                alert(`Unable to initiate call. Please call ${phoneNumber} directly.`);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const carListings = document.getElementById('carListings');
            const salesVehicleModals = document.getElementById('salesVehicleModals');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const categoryFilter = document.getElementById('categoryFilter');
            const priceFilter = document.getElementById('priceFilter');
            const conditionFilter = document.getElementById('conditionFilter');
            const yearFilter = document.getElementById('yearFilter');
            const applyFiltersBtn = document.getElementById('applyFilters');
            const resetFiltersBtn = document.getElementById('resetFilters');

            // Fetch sales vehicles from backend
            async function fetchSalesVehicles() {
                try {
                    const response = await fetch('/get_sales_vehicles');
                    const vehicles = await response.json();
                    
                    // Debug logging
                    console.log('Fetched Vehicles:', vehicles);
                    vehicles.forEach(vehicle => {
                        console.log(`Vehicle ${vehicle.id} Mileage:`, vehicle.mileage);
                    });

                    // Clear existing car listings and modals
                    carListings.innerHTML = '';
                    salesVehicleModals.innerHTML = '';

                    // Populate car listings and modals
                    vehicles.forEach(vehicle => {
                        const carCard = createCarCard(vehicle);
                        const carModal = createCarModal(vehicle);
                        
                        carListings.appendChild(carCard);
                        salesVehicleModals.appendChild(carModal);
                    });

                    // Update no results message
                    noResultsMessage.style.display = vehicles.length === 0 ? 'block' : 'none';
                } catch (error) {
                    console.error('Error fetching sales vehicles:', error);
                    noResultsMessage.textContent = 'Error loading vehicles. Please try again later.';
                    noResultsMessage.style.display = 'block';
                }
            }

            // Create car card dynamically
            function createCarCard(vehicle) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'col-md-4 car-card';
                cardDiv.setAttribute('data-category', vehicle.category);
                cardDiv.setAttribute('data-price', vehicle.price);
                cardDiv.setAttribute('data-condition', vehicle.condition);
                cardDiv.setAttribute('data-year', vehicle.year);
                cardDiv.setAttribute('data-gas-type', vehicle.gasType);
                cardDiv.setAttribute('data-plate', vehicle.plateNumber);
                cardDiv.setAttribute('data-make', vehicle.make);
                cardDiv.setAttribute('data-model', vehicle.model);
                cardDiv.setAttribute('data-color', vehicle.color);
                cardDiv.setAttribute('data-engine-size', vehicle.engineSize);
                cardDiv.setAttribute('data-drivetrain', vehicle.drivetrain);
                cardDiv.setAttribute('data-features', JSON.stringify(vehicle.features || []));

                cardDiv.innerHTML = `
                    <div class="card">
                        <img src="${vehicle.image || 'images/default-car.jpg'}" class="card-img-top car-image" alt="${vehicle.make} ${vehicle.model}">
                        <div class="card-body">
                            <h5 class="card-title">${vehicle.make} ${vehicle.model} ${vehicle.year}</h5>
                            <p class="card-text">${vehicle.description || 'No description available'}</p>
                            <div class="row">
                                <div class="col-6">
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-tag me-2"></i>${vehicle.condition}</li>
                                        <li><i class="fas fa-calendar me-2"></i>${vehicle.year} Model</li>
                                        <li><i class="fas fa-dollar-sign me-2"></i>KMF ${vehicle.price.toLocaleString()}</li>
                                    </ul>
                                </div>
                                <div class="col-6">
                                    <ul class="list-unstyled">
                                        <li><i class="fas fa-gas-pump me-2"></i>${vehicle.gasType}</li>
                                        <li><i class="fas fa-id-card me-2"></i>${vehicle.plateNumber}</li>
                                        <li><i class="fas fa-tachometer-alt me-2"></i>${vehicle.mileage ? vehicle.mileage.toLocaleString() + ' km' : 'N/A'}</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="h5 mb-0">KMF ${vehicle.price.toLocaleString()}</span>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#carModal${vehicle.id}">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                return cardDiv;
            }

            // Create car modal dynamically
            function createCarModal(vehicle) {
                const modalDiv = document.createElement('div');
                modalDiv.className = 'modal fade';
                modalDiv.id = `carModal${vehicle.id}`;
                modalDiv.setAttribute('tabindex', '-1');

                modalDiv.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${vehicle.make} ${vehicle.model} ${vehicle.year} Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <img src="${vehicle.image || 'images/default-car.jpg'}" class="img-fluid" alt="${vehicle.make} ${vehicle.model}">
                                        <div class="mt-3">
                                            <h6>Additional Images</h6>
                                            <div class="d-flex">
                                                ${vehicle.additionalImages ? vehicle.additionalImages.map(img => 
                                                    `<img src="${img}" class="img-thumbnail me-2" style="width: 100px;" alt="Additional Image">`
                                                ).join('') : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h4>${vehicle.make} ${vehicle.model} ${vehicle.year}</h4>
                                        <p>${vehicle.description || 'No description available'}</p>
                                        <div class="row">
                                            <div class="col-6">
                                                <ul class="list-unstyled">
                                                    <li><strong><i class="fas fa-dollar-sign me-2"></i>Price:</strong> KMF ${vehicle.price.toLocaleString()}</li>
                                                    <li><strong><i class="fas fa-tag me-2"></i>Condition:</strong> ${vehicle.condition}</li>
                                                    <li><strong><i class="fas fa-calendar me-2"></i>Year:</strong> ${vehicle.year}</li>
                                                    <li><strong><i class="fas fa-tachometer-alt me-2"></i>Mileage:</strong> ${vehicle.mileage !== null && vehicle.mileage !== undefined ? Number(vehicle.mileage).toLocaleString() + ' km' : 'N/A'}</li>
                                                </ul>
                                            </div>
                                            <div class="col-6">
                                                <ul class="list-unstyled">
                                                    <li><strong><i class="fas fa-car me-2"></i>Transmission:</strong> ${vehicle.transmission || 'N/A'}</li>
                                                    <li><strong><i class="fas fa-gas-pump me-2"></i>Fuel Type:</strong> ${vehicle.gasType}</li>
                                                    <li><strong><i class="fas fa-id-badge me-2"></i>Plate Number:</strong> ${vehicle.plateNumber}</li>
                                                    <li><strong><i class="fas fa-palette me-2"></i>Color:</strong> ${vehicle.color}</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <hr>
                                        <div class="row">
                                            <div class="col-6">
                                                <h6><i class="fas fa-cogs me-2"></i>Technical Details</h6>
                                                <ul class="list-unstyled">
                                                    <li><strong>Make:</strong> ${vehicle.make}</li>
                                                    <li><strong>Model:</strong> ${vehicle.model}</li>
                                                    <li><strong>Engine:</strong> ${vehicle.engineSize}</li>
                                                    <li><strong>Drivetrain:</strong> ${vehicle.drivetrain}</li>
                                                </ul>
                                            </div>
                                            <div class="col-6">
                                                <h6><i class="fas fa-star me-2"></i>Key Features</h6>
                                                <ul class="list-unstyled">
                                                    ${vehicle.features ? vehicle.features.map(feature => 
                                                        `<li><i class="fas fa-check me-2 text-success"></i>${feature}</li>`
                                                    ).join('') : 'No specific features listed'}
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button class="btn btn-primary mt-3" onclick='contactSellerWhatsApp(${JSON.stringify(vehicle)})'>Contact Seller</button>
                                            <button class="btn btn-success mt-3" onclick="callSeller('${vehicle.plateNumber}')">
                                                <i class="fas fa-phone me-2"></i>Call
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                return modalDiv;
            }

            // Existing filter functions (unchanged)
            function filterCars() {
                const selectedCategory = categoryFilter.value;
                const selectedPrice = priceFilter.value;
                const selectedCondition = conditionFilter.value;
                const selectedYear = yearFilter.value;

                const carCards = document.querySelectorAll('.car-card');
                let visibleCards = 0;

                carCards.forEach(card => {
                    const matchCategory = !selectedCategory || card.dataset.category === selectedCategory;
                    const matchPrice = !selectedPrice || isPriceInRange(card.dataset.price, selectedPrice);
                    const matchCondition = !selectedCondition || card.dataset.condition === selectedCondition;
                    const matchYear = !selectedYear || card.dataset.year === selectedYear;

                    if (matchCategory && matchPrice && matchCondition && matchYear) {
                        card.style.display = 'block';
                        visibleCards++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                noResultsMessage.style.display = visibleCards === 0 ? 'block' : 'none';
            }

            function isPriceInRange(price, range) {
                if (!range) return true;
                const [min, max] = range.split('-').map(Number);
                const priceNum = Number(price);
                
                if (range.includes('+')) {
                    return priceNum >= min;
                }
                return priceNum >= min && priceNum <= max;
            }

            function resetFilters() {
                categoryFilter.selectedIndex = 0;
                priceFilter.selectedIndex = 0;
                conditionFilter.selectedIndex = 0;
                yearFilter.selectedIndex = 0;
                filterCars();
            }

            // Initial fetch of sales vehicles
            fetchSalesVehicles();

            applyFiltersBtn.addEventListener('click', filterCars);
            resetFiltersBtn.addEventListener('click', resetFilters);
        });
    </script>
</body>
</html>
