<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Management - CarRent Comores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .vehicle-card {
            transition: transform 0.3s ease;
        }
        .vehicle-card:hover {
            transform: translateY(-5px);
        }
        .vehicle-image {
            height: 200px;
            object-fit: cover;
        }
        #previewImage {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
        }
        #image_url {
            border: 1px solid #ccc; 
            border-radius: 4px; 
            padding: 10px; 
            width: 100%; 
            max-width: auto;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="dashboard.html">
                <img src="/assets/logo.jpg" alt="CarRent Comores Logo" width="60" height="60" class="me-3 rounded img-thumbnail">
                CarRent Comores - Sales Management
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="bookings.html">Bookings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="sales_management.html">Sales Management</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="admin-login.html">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5 pt-5">
        <div class="row mb-4">
            <div class="col-12">
                <h2>Sales Vehicle Management</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addVehicleModal">
                    <i class="fas fa-plus me-2"></i>Add New Vehicle
                </button>
            </div>
        </div>

        <!-- Vehicle Listings -->
        <div id="vehicleListings" class="row g-4">
            <!-- Vehicles will be dynamically populated here -->
        </div>
    </div>

    <!-- Add/Edit Vehicle Modal -->
    <div class="modal fade" id="addVehicleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Vehicle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="vehicleForm" enctype="multipart/form-data">
                        <input type="hidden" id="vehicleId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Make</label>
                                <input type="text" class="form-control" id="make" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Model</label>
                                <input type="text" class="form-control" id="model" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Year</label>
                                <input type="number" class="form-control" id="year" required min="1900" max="2025">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="category" required>
                                    <option value="">Select Category</option>
                                    <option value="Sedan">Sedan</option>
                                    <option value="SUV">SUV</option>
                                    <option value="Luxury">Luxury</option>
                                    <option value="Compact">Compact</option>
                                    <option value="Pickup">Pickup</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Condition</label>
                                <select class="form-select" id="condition" required>
                                    <option value="">Select Condition</option>
                                    <option value="New">New</option>
                                    <option value="Used">Used</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Price (KMF)</label>
                                <input type="number" class="form-control" id="price" required min="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Color</label>
                                <input type="text" class="form-control" id="color" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Engine Size</label>
                                <input type="text" class="form-control" id="engineSize" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Gas Type</label>
                                <select class="form-select" id="gasType" required>
                                    <option value="">Select Gas Type</option>
                                    <option value="Petrol">Petrol</option>
                                    <option value="Diesel">Diesel</option>
                                    <option value="Hybrid">Hybrid</option>
                                    <option value="Electric">Electric</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Transmission</label>
                                <select class="form-select" id="transmission" required>
                                    <option value="">Select Transmission</option>
                                    <option value="Automatic">Automatic</option>
                                    <option value="Manual">Manual</option>
                                    <option value="Semi-Automatic">Semi-Automatic</option>
                                    <option value="CVT">CVT (Continuously Variable Transmission)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Drivetrain</label>
                                <select class="form-select" id="drivetrain" required>
                                    <option value="">Select Drivetrain</option>
                                    <option value="FWD">FWD</option>
                                    <option value="RWD">RWD</option>
                                    <option value="AWD">AWD</option>
                                    <option value="4WD">4WD</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Plate Number</label>
                                <input type="text" class="form-control" id="plateNumber" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="vehicleMileage" class="form-label">Mileage (km)</label>
                                <input type="number" class="form-control" id="vehicleMileage" name="mileage" min="0" placeholder="Enter vehicle mileage">
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">Features (comma-separated)</label>
                                <input type="text" class="form-control" id="features" placeholder="e.g., Backup Camera, Bluetooth, Cruise Control">
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="description" rows="3" required></textarea>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label" for="image_url">Image URL:</label>
                                <input type="text" id="image_url" name="image_url" placeholder="Enter image URL" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Save Vehicle</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Check admin authentication
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('isLoggedIn') !== 'true') {
                window.location.href = 'admin-login.html';
                return;
            }

            loadVehicles();
            setupFormHandling();
        });

        function loadVehicles() {
            fetch('/get_sales_vehicles')
                .then(response => response.json())
                .then(vehicles => {
                    const vehicleListings = document.getElementById('vehicleListings');
                    vehicleListings.innerHTML = '';

                    vehicles.forEach(vehicle => {
                        const card = createVehicleCard(vehicle);
                        vehicleListings.appendChild(card);
                    });
                })
                .catch(error => console.error('Error loading vehicles:', error));
        }

        function createVehicleCard(vehicle) {
            const div = document.createElement('div');
            div.className = 'col-md-4 mb-4';
            div.innerHTML = `
                <div class="card">
                    <img src="${vehicle.image || 'images/default-car.jpg'}" class="card-img-top" alt="${vehicle.make} ${vehicle.model}">
                    <div class="card-body">
                        <h5 class="card-title">${vehicle.make} ${vehicle.model} ${vehicle.year}</h5>
                        <div class="row">
                            <div class="col-6">
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-tag me-2"></i>${vehicle.condition}</li>
                                    <li><i class="fas fa-calendar me-2"></i>${vehicle.year} Model</li>
                                    <li><i class="fas fa-dollar-sign me-2"></i>KMF ${vehicle.price.toLocaleString()}</li>
                                </ul>
                            </div>
                            <div class="col-6">
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-gas-pump me-2"></i>${vehicle.gasType}</li>
                                    <li><i class="fas fa-id-card me-2"></i>${vehicle.plateNumber}</li>
                                    <li><i class="fas fa-tachometer-alt me-2"></i>${vehicle.mileage ? vehicle.mileage.toLocaleString() + ' km' : 'N/A'}</li>
                                </ul>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-primary" onclick="editVehicle(${vehicle.id})">
                                <i class="fas fa-edit me-2"></i>Edit
                            </button>
                            <button class="btn btn-danger" onclick="deleteVehicle(${vehicle.id})">
                                <i class="fas fa-trash me-2"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
            return div;
        }

        function setupFormHandling() {
            const form = document.getElementById('vehicleForm');
            const modal = new bootstrap.Modal(document.getElementById('addVehicleModal'));

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = new FormData();
                const vehicleId = document.getElementById('vehicleId').value;
                const fields = [
                    'make', 'model', 'year', 'category', 'condition', 'price',
                    'color', 'engineSize', 'gasType', 'transmission', 'drivetrain', 'plateNumber',
                    'features', 'description', 'vehicleMileage', 'image_url'
                ];

                fields.forEach(field => {
                    const value = document.getElementById(field).value;
                    formData.append(field, value);
                    console.log(`Field ${field}: ${value}`);  // Debug logging
                });

                const url = vehicleId ? `/update_sales_vehicle/${vehicleId}` : '/add_sales_vehicle';
                const method = vehicleId ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method: method,
                        body: formData
                    });

                    if (response.ok) {
                        // Immediately reload the page after successful vehicle addition
                        location.reload();
                    } else {
                        // Handle error case
                        const errorData = await response.json();
                        alert(errorData.message || 'Failed to add vehicle');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while saving the vehicle');
                }
            });
        }

        function editVehicle(id) {
            fetch(`/get_sales_vehicle/${id}`)
                .then(response => response.json())
                .then(vehicle => {
                    document.getElementById('vehicleId').value = vehicle.id;
                    document.getElementById('make').value = vehicle.make;
                    document.getElementById('model').value = vehicle.model;
                    document.getElementById('year').value = vehicle.year;
                    document.getElementById('category').value = vehicle.category;
                    document.getElementById('condition').value = vehicle.condition;
                    document.getElementById('price').value = vehicle.price;
                    document.getElementById('color').value = vehicle.color;
                    document.getElementById('engineSize').value = vehicle.engineSize;
                    document.getElementById('gasType').value = vehicle.gasType;
                    document.getElementById('transmission').value = vehicle.transmission;
                    document.getElementById('drivetrain').value = vehicle.drivetrain;
                    document.getElementById('plateNumber').value = vehicle.plateNumber;
                    document.getElementById('features').value = vehicle.features.join(', ');
                    document.getElementById('description').value = vehicle.description;
                    document.getElementById('vehicleMileage').value = vehicle.mileage;
                    document.getElementById('image_url').value = vehicle.image;

                    document.querySelector('#addVehicleModal .modal-title').textContent = 'Edit Vehicle';
                    new bootstrap.Modal(document.getElementById('addVehicleModal')).show();
                })
                .catch(error => console.error('Error loading vehicle details:', error));
        }

        function deleteVehicle(id) {
            if (confirm('Are you sure you want to delete this vehicle?')) {
                fetch(`/delete_sales_vehicle/${id}`, { method: 'DELETE' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadVehicles();
                        } else {
                            alert(data.message || 'Failed to delete vehicle');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the vehicle');
                    });
            }
        }
    </script>
</body>
</html>
